name: 'Warpforge'
description: 'experimental warpforge execution'
inputs:
  ref:
    description: 'git ref for warpforge tag, branch, commit'
    default: master
  bin:
    description: 'bin path for warpforge'
    default: ${{ runner.temp }}/warpforge/bin
  path:
    description: 'build path for warpforge repository'
    default: ${{ runner.temp }}/warpforge
runs:
  using: "composite"
  steps:
    - name: Checkout Warpforge
      uses: actions/checkout@v3
      with:
        repository: warptools/warpforge
        ref: ${{ inputs.ref }}
        path: ${{ inputs.path }}
    - name: warpforge hash
      id: wf-hash
      shell: bash
      run: echo "git-hash=$(git rev-parse HEAD)"" >> $GITHUB_OUTPUT
    - name: Cache Warpforge
      id: cache
      uses: actions/cache@v3
      with:
        path: ${{ inputs.bin }}
        key: ${{ steps.wf-hash.outputs.git-hash }}
    - uses: actions/setup-go@v3
      if: steps.cache.outputs.cache-hit != 'true'
      with:
        go-version: '^1.18' # The Go version to download (if necessary) and use.
    - name: Install Warpforge
      if: steps.cache.outputs.cache-hit != 'true'
      working-directory: ${{ inputs.path }}
      env:
        GOBIN: ${{ inputs.bin }}
      run: |
        cp ./plugins/* "${GOBIN}/"
        go install ./...
      shell: bash
    - name: Execute warpforge
      run: |
        PATH=${PATH}:"${{ inputs.path }}"
        mkdir -p ~/.warpforge/cache
        warpforge run
      shell: bash
